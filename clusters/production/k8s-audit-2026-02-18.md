# Kubernetes GitOps Environment - Full Audit Report

**Date:** February 18, 2026
**Scope:** 142+ YAML files across `/home/wrees/k8s-gitops`
**Platform:** Flux CD v2.7.5, bare-metal Kubernetes cluster

---

## CRITICAL Findings (Fix Immediately)

### 1. Hardcoded Plaintext Database Credentials — REMEDIATED
- **File:** `automation/compreface/1-db.yaml` (lines 25-30)
- **Issue:** PostgreSQL credentials hardcoded as `postgres`/`postgres` in plaintext
- **Fix:** Create a SealedSecret for CompreFace DB credentials and reference via `envFrom` or `env[].valueFrom.secretKeyRef`
- **Status:** Remediated — created `compreface-db-secret-sealed.yaml` SealedSecret and updated `1-db.yaml`, `3-api.yaml`, `4-admin.yaml` to use `secretKeyRef`

### 2. Plaintext API Key in Git — REMEDIATED
- **File:** `games/minecraft/minecraft-bettergame-release.yaml` (line 14)
- **Issue:** `CF_API_KEY` value committed in plaintext Secret manifest
- **Fix:** Seal with sealed-secrets, reference via SealedSecret
- **Status:** Remediated — created `curseforge-api-sealed.yaml` SealedSecret and removed plaintext Secret block from `minecraft-bettergame-release.yaml`

### 3. Basic Auth Over HTTP (Longhorn UI)
- **File:** `core/longhorn/longhorn-ingress.yaml` (line 10)
- **Issue:** `nginx.ingress.kubernetes.io/ssl-redirect: 'false'` sends basic auth credentials in cleartext
- **Fix:** Set `ssl-redirect: 'true'` or switch to `internal-nginx` ingressClass with TLS

### 4. cluster-admin Bound to Dashboard ServiceAccount
- **File:** `monitoring/kubernetes-dashboard/dashboard-admin.yaml`
- **Issue:** ServiceAccount `warren` has `cluster-admin` ClusterRoleBinding - dashboard compromise = full cluster takeover
- **Fix:** Create a scoped ClusterRole with read-only or namespace-limited permissions

---

## HIGH Findings

### 5. Outdated PostgreSQL 11.5 (EOL Oct 2023)
- **File:** `automation/compreface/1-db.yaml` (line 33)
- **Issue:** `image: postgres:11.5` - multiple known CVEs, no security patches
- **Fix:** Upgrade to `postgres:16` (or latest LTS), test CompreFace compatibility

### 6. NGINX Snippet Injection Enabled
- **File:** `core/ingress-nginx/ingress-nginx-release.yaml` (line 23)
- **Issue:** `allowSnippetAnnotations: true` allows arbitrary nginx config injection by anyone who can create Ingress resources
- **Fix:** Set to `false` unless explicitly required; if needed, use `annotation-value-word-blocklist`

### 7. Privileged Containers (3 deployments)
| File | Justification |
|------|---------------|
| `automation/frigate/frigate-release.yaml` (line 82) | Coral USB TPU access - justified but review |
| `automation/esphome/esphome-release.yaml` (line 31) | Serial device access - justified but review |
| `automation/zigbee2mqtt/zigbee2mqtt-release.yaml` (line 41) | Zigbee USB stick - justified but review |

- **Fix:** Where possible, replace `privileged: true` with specific device mounts (`/dev/ttyUSB0`) and targeted capabilities. For Frigate, consider using device plugin instead.

### 8. hostNetwork: true (4 application deployments)
| File | Reason |
|------|--------|
| `automation/music-assistant/music-assistant-release.yaml` | mDNS discovery |
| `automation/govee2mqtt/govee2mqtt-release.yaml` | LAN device discovery |
| `automation/esphome/esphome-release.yaml` | mDNS/device access |
| `media/wyzebridge/wyzebridge-release.yaml` | Camera streaming |

- **Fix:** Evaluate if any can work with `hostPort` or specific port mappings instead. Document justification for those that truly need it.

### 9. Dangerous Linux Capabilities
- **File:** `automation/music-assistant/music-assistant-release.yaml` (lines 35-39)
- **Issue:** `SYS_ADMIN` and `DAC_READ_SEARCH` capabilities added
- **Fix:** Investigate minimum capabilities needed; `SYS_ADMIN` is nearly equivalent to `privileged`

### 10. No NetworkPolicies (entire cluster except flux-system)
- **Issue:** Zero network segmentation across all application namespaces - any compromised pod can reach any other pod
- **Fix:** Implement default-deny NetworkPolicies per namespace, then allow specific ingress/egress. Start with `identity` and `monitoring` namespaces.

### 11. No PodDisruptionBudgets — PARTIALLY REMEDIATED
- **Issue:** Zero PDBs found - node drain/maintenance can take down all replicas of critical services simultaneously
- **Fix:** Add PDBs for: ingress-nginx (minAvailable: 2), sealed-secrets, cert-manager, metallb, pihole, authentik
- **Status:** Partially remediated — added PDBs for multi-replica workloads: ingress-nginx (minAvailable: 2), internal-nginx (minAvailable: 2), metrics-server (minAvailable: 1). Single-replica workloads excluded to avoid blocking node drains.

### 12. Missing Resource Requests/Limits (~41 deployments)
- **Issue:** Nearly all deployments lack resource constraints - no QoS guarantees, risk of noisy neighbor and OOM kills
- **Fix:** Add at minimum memory requests/limits to all deployments. Start with infrastructure components, then applications.

---

## MEDIUM Findings

### 13. Missing securityContext (~34 deployments)
- **Issue:** Most pods run as root by default with full capabilities
- **Fix:** Add baseline securityContext to all non-privileged deployments:
  ```yaml
  securityContext:
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop: ["ALL"]
  ```

### 14. :latest Image Tags (4 deployments)
| File | Image |
|------|-------|
| `media/voice/whisper-release.yaml` | `rhasspy/wyoming-whisper:latest` |
| `media/voice/piper-release.yaml` | `rhasspy/wyoming-piper:latest` |
| `media/voice/openwakeword-release.yaml` | `rhasspy/wyoming-openwakeword:latest` |
| `utilities/ps/ps-release.yaml` | `warrenrees/property-search:latest` |

- **Fix:** Pin to specific semver tags; add Flux ImagePolicy for automated updates

### 15. Missing Liveness/Readiness Probes (~33 deployments)
- **Issue:** Only 8 deployments have health probes; dead containers won't auto-restart
- **Fix:** Add HTTP or TCP probes to all long-running services, starting with stateful services (databases, MQTT)

### 16. Missing HelmRelease `spec.interval` (multiple releases)
- **Files:** `metallb-release.yaml`, `node-feature-discovery-release.yaml`, `intel-gpu-plugin-helm-release.yaml`
- **Fix:** Add explicit `interval` to all HelmReleases for predictable reconciliation

### 17. Deprecated Ingress Annotations — REMEDIATED
- **File:** `automation/influxdb/influxdb2-release.yaml`
- **Issue:** Uses both `kubernetes.io/ingress.class` annotation AND `ingressClassName` field (redundant, annotation is deprecated)
- **Fix:** Remove deprecated annotation, keep only `ingressClassName`
- **Status:** Remediated — removed deprecated annotations from influxdb, ps, vaultwarden, frigate ingresses; added `ingressClassName` to frigate; replaced annotation with `className` for Hubble UI in cilium Helm values

### 18. Applications in `default` Namespace
- **Issue:** ~20+ applications deploy to `default` namespace (Plex, Immich, Frigate, voice services, Minecraft, etc.) despite dedicated namespaces being defined in `rees-namespace.yaml`
- **Fix:** Move workloads to their defined namespaces (`media`, `automation`, `games`, `ai`)

### 19. Confusing Comment in Intel GPU Plugin — REMEDIATED
- **File:** `media/intel-gpu-plugin/intel-gpu-plugin-helm-release.yaml` (line 18)
- **Issue:** Comment says "equivalent of -shared-dev-num=4" but value is `sharedDevNum: 3`
- **Fix:** Correct comment or value to match
- **Status:** Remediated — corrected comment to say `-shared-dev-num=3`

### 20. Image Automation Pushes Directly to Main
- **File:** `flux-image-updates/flux-system-automation.yaml`
- **Issue:** `ImageUpdateAutomation` commits directly to `main` branch every 1 minute
- **Fix:** Consider pushing to a feature branch with auto-PR for review, or increase interval

---

## LOW Findings

### 21. Unused Namespace Definition
- **File:** `rees-namespace.yaml` defines `istio-system` but no Istio resources exist
- **Fix:** Remove unused namespace definition or add TODO comment

### 22. Missing Standard Kubernetes Labels — REMEDIATED
- **Issue:** Inconsistent use of `app.kubernetes.io/*` labels across deployments
- **Fix:** Standardize labels: `app.kubernetes.io/name`, `app.kubernetes.io/instance`, `app.kubernetes.io/managed-by`
- **Status:** Remediated — added standard labels to 10 manually-managed workloads (compreface, lidarr, ombi, immich)

### 23. NFS Mount Options Commented Out
- **Issue:** PV definitions have mount options (hard, nfsvers=4) commented out
- **Fix:** Enable `hard` and `nfsvers=4.1` mount options for reliability

### 24. No Flux Remediation/Retry Settings — REMEDIATED
- **Issue:** HelmReleases lack `install.remediation` and `upgrade.remediation` blocks
- **Fix:** Add retry settings to prevent stuck releases:
  ```yaml
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  ```
- **Status:** Remediated — added remediation/retry settings to all 20 HelmRelease objects across 19 files

---

## Positive Findings

- All Flux toolkit resources use current API versions (v1/v2) - no deprecated APIs
- SealedSecrets properly used for most credentials (13 sealed secrets found)
- cert-manager with Let's Encrypt production issuer properly configured
- Flux image automation working for many deployments with semver policies
- MetalLB IPAddressPool and L2Advertisement correctly configured
- Prometheus ServiceMonitors and PrometheusRules for Longhorn, Flux, and Ingress-NGINX
- CRD lifecycle management (install: Create, upgrade: CreateReplace) correct in relevant HelmReleases
- Ingress-NGINX running 3 replicas for HA
- PersistentVolumes use `Retain` reclaim policy (prevents data loss)

---

## Recommended Remediation Order

| Phase | Items | Effort |
|-------|-------|--------|
| **Week 1** | #1 CompreFace creds, #2 Minecraft API key, #3 Longhorn SSL, #4 Dashboard RBAC, #6 NGINX snippets | Low |
| **Week 2** | #5 Postgres upgrade, #10 NetworkPolicies (identity, monitoring), #11 PDBs for infra | Medium |
| **Week 3-4** | #12 Resource limits (infra first), #13 securityContext baseline, #14 Pin :latest tags | Medium |
| **Month 2** | #7-9 Review privileged/hostNetwork, #15 Health probes, #16-17 HelmRelease cleanup | Medium |
| **Month 3** | #18 Namespace migration, #20 Image automation branching, #22 Label standardization | High |

---

## Verification Steps

After each remediation phase:
1. `flux reconcile kustomization flux-system --with-source` to force reconciliation
2. `flux get helmreleases -A` to verify all releases are Ready
3. `kubectl get pods -A` to check no CrashLoopBackOff or pending pods
4. For sealed secrets: `kubeseal --validate` against the cluster
5. For NetworkPolicies: test connectivity between namespaces with `kubectl exec` curl tests
6. For RBAC changes: verify dashboard still works with reduced permissions
